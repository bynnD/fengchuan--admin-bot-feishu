# 用印文件提取与识别问题排查

## 可能原因

### 1. DEEPSEEK_API_KEY 未配置（最常见）
- **现象**：日志出现「用印提取: DEEPSEEK_API_KEY 未配置」
- **处理**：在 Railway / 环境变量中配置 `DEEPSEEK_API_KEY`

### 2. 文件提取器未注册
- **现象**：日志出现「用印提取: 未找到 extractor」
- **处理**：确认 `approval_types/seal.py` 中 `HAS_FILE_EXTRACTION = True` 且实现了 `extract_fields_from_file`

### 3. Word 解析失败
- **现象**：日志出现「Word 解析失败(xxx.docx): ...」
- **原因**：.doc 旧格式、文档损坏、或 python-docx 不支持的格式
- **处理**：此时会退化为仅根据文件名推断，若仍失败则检查 AI 调用

### 4. 飞书 OCR 失败（图片/扫描件）
- **现象**：日志出现「飞书 OCR 失败」或「飞书 OCR 异常」
- **原因**：应用未开通 OCR 权限、token 失效、图片过大
- **处理**：在飞书开放平台为应用开通「光学字符识别」权限

### 5. DeepSeek API 调用失败
- **现象**：日志出现「从文件内容推断用印信息失败」
- **原因**：API Key 无效、网络超时、余额不足
- **处理**：检查 DeepSeek 控制台，确认 Key 有效且有余额

### 6. AI 返回格式不符合
- **现象**：无「用印文件识别结果」日志，也无报错
- **原因**：AI 返回的 JSON 中 company/seal_type/reason 为空或 key 不匹配
- **处理**：查看完整 traceback（已增强日志）

## 诊断步骤

1. **访问调试接口**（部署后）：
   ```
   GET https://你的域名/debug-extract
   ```
   返回示例：
   ```json
   {
     "extractor_registered": true,
     "file_extractors": ["用印申请单"],
     "DEEPSEEK_API_KEY_set": true,
     "DEEPSEEK_API_KEY_len": 32,
     "hint": "若 extractor_registered 为 false 或 DEEPSEEK_API_KEY_set 为 false，则无法识别"
   }
   ```

2. **查看 Railway 日志**：上传文件后应出现：
   - `用印文件: 已下载 xxx.docx, 大小=xxx bytes`
   - `用印文件识别结果: {...}`（成功时）
   - 或上述任一报错信息

3. **确认环境变量**：Railway 项目设置中必须有 `DEEPSEEK_API_KEY`
